---
title: "Homework Problem Set 13: Inferences for $p_1-p_2$ from Independent Samples"
output: 
  html_document: 
    theme: readable
  pdf_document: default
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, out.width = "100%", fig.align = "center", 
  cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

```{r packages}
library(tidyverse)
suppressWarnings(library(kableExtra))
```

```{r utilities}
source("../../utilities.R")
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](homework-13.pdf) copy of this homework assignment.", sep = ""), "")`

```{r functions}
stat <- function(p, n) {
  p1 <- p[1]
  p2 <- p[2]
  n1 <- n[1]
  n2 <- n[2]
  pp <- (p1*n1 + p2*n2)/(n1+n2)
  return((p1-p2)/sqrt(pp*(1-pp)*(1/n1+1/n2)))
}

serr <- function(p, n) {
  p1 <- p[1]
  p2 <- p[2]
  n1 <- n[1]
  n2 <- n[2]
  return(sqrt(p1*(1-p1)/n1 + p2*(1-p2)/n2))
}

pval <- function(z, side = "two") {
  switch(side, 
    two = 2 * pnorm(-abs(z)),
    left = pnorm(z),
    right = 1 - pnorm(z))
}

elst <- function(x) {
  n <- length(x)
  y <- paste(x[1:(n-1)], collapse = ", ")
  y <- paste(y, ", and ", x[n], sep = "")
  return(y)
}
```

Instructions: These homework problems will help familiarize you with how we can make inferences concerning the difference between two probabilities (i.e., $p_1 - p_2$). For statistical tests state appropriate null and alternative hypotheses, compute the test statistic, compute the p-value, and make a decision/conclusion. Use a significance level of $\alpha$ = 0.05. For confidence intervals use a confidence level of 95%. The solutions are given at the end.[^rounding]

[^rounding]: In the solutions the reported values of test statistics and p-values have been rounded some. Rounding was only done for the final reported values. It was avoided in intermediate calculations (e.g., the value of the test statistic used to compute a p-value was *not* rounded). 

## Sex Role Stereotypes in Personnel Decisions

```{r}
x <- c(21,14)
n <- c(24,24)
```

Rosen and Jerdee (1974) conducted a randomized experiment to investigate sex role stereotypes in personnel decisions.[^sexrole] The subjects were 48 male bank supervisors attending a management institute. Each manager was given a hypothetical personnel file and asked if the applicant described in the file should be promoted. The contents of the files were *identical* except in half of the files the applicant was listed as a man, and in the other half the applicant was listed as a woman. Of the `r n[1]` managers who were given the file of a male applicant, `r x[1]` recommended promotion, and of the `r n[2]` managers who were given the file of a female applicant, `r x[2]` recommended promotion. Let $p_m$ denote the probability that a manager will recommend promotion of the *male* applicant, and let $p_f$ denote the probability that a manager will recommend promotion of the *female* applicant. A statistical test can be used to determine if there is a relationship between the sex of the applicant and the promotion decision using the hypotheses $H_0: p_m - p_f = 0$ (i.e., the probability of promotion is the same regardless of gender) versus $H_a: p_m - p_f \neq 0$ (i.e., the probability of promotion is not the same for the two genders). Conduct this statistical test including computing the test statistic, the p-value, and determining whether or not the null hypothesis would be rejected. 

## Comparison of Two Drugs for Nausea from Chemotherapy

```{r}
x <- c(36,16)
n <- c(79,78)
```

An article in the *New England Journal of Medicine* described a randomized experiment that investigated the effectiveness of two medications for nausea in patients undergoing chemotherapy treatments for cancer.[^thc] In the experiment, `r sum(n)` patients were divided at random into two groups. One group of 78 patients were given a standard anti-nausea drug called prochlorperazine, while the other group of 79 patients received delta-9-tetrahydrocannabinol (i.e., THC, the active ingredient in marijuana). Both medications were delivered orally and no patients were told which of the two drugs they were taking. The observed response was whether or not the patient experienced relief from nausea when undergoing chemotherapy. `r x[2]` of the patients taking prochlorperazine experienced relief from nausea, while `r x[1]` of the patients taking THC experienced relief from nausea. Conduct a statistical test to determine whether or not the probability of a patient experiencing relief from nausea is the same when taking THC versus prochlorperazine. This includes stating the null and alternative hypotheses, computing the test statistic, computing the p-value, and deciding whether or not the null hypothesis is rejected. You may use a one-sided or two-sided test. 

[^thc]: Sallan, S. E., Cronin, C., Zelen, M., \& Zinberg, N. E. (1980). Antiemetics in patients receiving chemotherapy for cancer: a randomized comparison of delta-9-tetrahydrocannabinol and prochlorperazine. *New England Journal of Medicine*, *302(3)*. 135--138.

## Aflatoxicol and Liver Tumors in Trout

Aflatoxicol is a metabolite of Aflatoxin $\text{B}_1$, a toxin produced by mold that infects cottonseed meal, peanuts, and grains. It sometimes finds its way into freshwater systems. Researchers at the Marine/Freshwater Biomedical Sciences Center at Oregon State University conducted a randomized experiment to investigate the carcinogenic effects of aflatoxicol in rainbow trout (*Oncorhynchus mykiss*). Tanks of trout embryos were exposed to one of five doses (0.01, 0.025, 0.05, 0.1, or 0.25 ppm) of aflatoxicol for one hour.[^tanks] Figure 1 shows the proportion of trout at each dose that developed liver tumors after one year. 
```{r, fig.height = 4, fig.cap = "Proportion of rainbow trout with liver tumors one year after exposure to aflatoxicol.", warning = FALSE}
library(ggrepel)
d <- Sleuth3::ex2116 %>% group_by(Dose) %>% summarize(Tumor = sum(Tumor), Total = sum(Total))
d$labels <- with(d, paste(Tumor, "/", Total, sep = ""))
d$labels[c(1,2,5)] <- NA
set.seed(101)
p <- ggplot(d, aes(x = Dose, y = Tumor/Total))
p <- p + geom_point() + theme_classic() + ylim(0,1)
p <- p + labs(x = "Dose of Aflatoxicol (ppm)", y = "Proportion of Trout With Tumors")
p <- p + geom_label_repel(aes(label = labels), box.padding = unit(1.5, "lines"), segment.color = "black", color = "black", fill = "white")
p <- p + scale_x_continuous(breaks = c(0.01, 0.025, 0.05, 0.1, 0.25))
plot(p)
```
Let $p_{\scriptsize 0.1}$ denote the probability that a trout will develop liver tumors in one year after exposure to aflatoxicol at a dose of 0.01 ppm, and let $p_{\scriptsize 0.05}$ denote the probability of the same event but with a dose of 0.05 ppm. Compute an estimate, margin of error, and confidence interval for the difference between these two probabilities --- i.e., $p_{\scriptsize 0.1} - p_{\scriptsize 0.05}$. Note that the sample sizes (353 and 355) are given in the figure, as well as the proportions of trout in each sample (226/353 and 281/355).

[^tanks]: There were four tanks of trout embryos per dose for a total of 20 tanks. For simplicity I have combined the data for the tanks at each distinct value of dose. But a more sophisticated analysis would take into account possible variation between tanks. 

## Foot Lice Infestation Survey

```{r}
n <- c(400,100,200,400)
x <- n * c(0.25, 0.2, 0.1, 0.2)
```

Researchers at the National Institutes of Hobbit Health (NIHH) are concerned about a possible outbreak of foot lice in the South Farthing.[^farthing] They have already made inferences about the incidence of foot lice in the South Farthing based on a simple random sample of `r n[1]` Hobbits. But now they want to compare the incidence of foot lice in the South Farthing to that in the North, East, and West Farthings. For this they obtained simple random samples of Hobbits from each of the other Farthings. The sizes of the samples from each Farthing and the number of infested Hobbits in the sample are shown in the table below. 
```{r}
d <- data.frame(Farthing = c("South","East","North","West"), 
  yes = x, no = n - x, Total = n)
ktbl(d) %>% add_header_above(c(" " = 1, "Foot Lice?" = 2, " " = 1))
```
Let $p_n$, $p_s$, $p_e$, and $p_w$ denote the probability that a randomly selected Hobbit from the North, South, East, or West Farthing, respectively, has foot lice. Here each probability can also be interpreted as the *proportion* of all Hobbits in a giving Farthing that a with foot lice. Compute point estimates of differences in the proportion of Hobbits infested with foot lice in the East, North, and West Farthings versus the South Farthing (i.e., $p_s-p_e$, $p_s-p_n$, and $p_s-p_w$) as well as the associated margins of error and confidence intervals for estimating these quantities.

[^farthing]: Most Hobbits live in a region known as the *Shire*. It is divided into four regions or *Farthings*: North, South, East, and West.  

\pagebreak

## Sex Role Stereotypes in Personnel Decisions (Solution)

```{r}
x <- c(21,14)
n <- c(24,24)
```

The value of the test statistic is $z$ $\approx$ `r round(stat(x/n, n), 2)`. For a two-sided test this would yield a p-value of approximately `r round(pval(stat(x/n, n), side = "two"), 3)`. Had the researchers used a one-sided test with the alternative hypothesis $H_a: p_m - p_f \neq 0$ (i.e., the probability of promotion is higher for male applicants) then the p-value would have been approximately `r round(pval(stat(x/n, n), side = "right"), 3)`. In either case we would reject the null hypothesis and conclude that there is a statistically significant difference between the proportions of male and female applicants who were recommended promotion. The probability of promotion was not the same for male and female applicants. 

[^sexrole]: Rosen, B. & Jerdee, J. (1974). Influence of sex role stereotypes on personnel decisions. *Journal of Applied Psychology*, *59*, 9--14. 

## Comparison of Two Drugs for Nausea from Chemotherapy (Solution)

```{r}
x <- c(36,16)
n <- c(79,78)
```

Let $p_t$ and $p_p$ denote the probabilities that a patient will report experiencing relief from nausea after having been administered THC or prochlorperazine, respectively. Appropriate hypotheses would be $H_0\!:p_t - p_p = 0$ versus $H_a\!:p_t - p_p \neq 0$. However if we had anticipated that THC would be more effective so that $p_t > p_p$ we could also use the one-sided test with hypotheses $H_0\!:p_t - p_p = 0$ versus $H_a\!:p_t - p_p > 0$, or a one-sided test with a composite null hypothesis $H_0\!:p_t - p_p \le 0$. The value of the test statistic is $z$ $\approx$ `r round(stat(x/n, n), 2)`. For a two-sided test this would yield a p-value of approximately `r round(pval(stat(x/n, n), side = "two"), 3)`. For a one-sided test the p-value would be half of the p-value from the two-sided test. In either case we would conclude that the apparent difference in the effectiveness of the two drugs is statistically significant. The probability of experiencing relief does depend on whether the patient was administered THC or prochlorperazine.

## Aflatoxicol and Liver Tumors in Trout (Solutions)

```{r}
p2 <- 281/355
p1 <- 226/353
n1 <- 355
n2 <- 353
me <- 1.96*sqrt(p1*(1-p1)/n1 + p2*(1-p2)/n2)
```

The point estimate is just the difference in the proportions, which is `r rnd(p2-p1,2)`. The margin of error is `r rnd(me,2)`. This yields a confidence interval of approximately `r round(p2-p1,2)` $\pm$ `r round(me,2)`.

## Foot Lice Infestation Survey (Solution)

The point estimates, margins of error, and confidence intervals are shown in the table below. The margins of error have been rounded to the third decimal place.

```{r}
n <- c(400,100,200,400)
x <- n * c(0.25, 0.2, 0.1, 0.2)
p <- x/n
pse <- p[1] - p[2]
mse <- round(1.96 * sqrt(p[1] * (1 - p[1]) / n[1] + p[2] * (1 - p[2]) / n[2]),3)
psn <- p[1] - p[3]
msn <- round(1.96 * sqrt(p[1] * (1 - p[1]) / n[1] + p[3] * (1 - p[3]) / n[3]),3)
psw <- p[1] - p[4]
msw <- round(1.96 * sqrt(p[1] * (1 - p[1]) / n[1] + p[4] * (1 - p[4]) / n[4]),3)

ci <- c(paste(pse, "$\\pm$", mse), paste(psn, "$\\pm$", msn), paste(psw, "$\\pm$", msw))

d <- data.frame(Quantity = c("$p_s-p_e$","$p_s-p_n$","$p_s-p_w$"),
  Estimate = c(pse, psn, psw), me = c(mse, msn, msw),
  ci = ci)
names(d)[3:4] <- c("Margin of Error", "Confidence Interval")
ktbl(d)
```


