---
title: "Homework Problem Set 8: Sampling Without Replacement and Estimating Totals"
output: 
  html_document: 
    theme: readable
  pdf_document: default
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, out.width = "100%", fig.align = "center", 
  cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "tikz"))
```

```{r packages}
library(tidyverse)
library(kableExtra)
```

```{r utilities}
source("../../utilities.R")
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](homework-08.pdf) copy of this homework assignment.", sep = ""), "")`

These problems check your understanding of how to (a) account for sampling without replacement in the calculation of a margin of error and (b) estimation a population total when sampling without replacement. The answers to each problem are given within the problem. You should be able to get the same results. 

**Note**: For simplicity use $t$ = 2 when computing margins of error and confidence intervals in these problems.

```{r}
N <- 500
n <- 100
m <- 25
s <- 5
se.srs <- s/sqrt(n) * sqrt(1 - n/N)
se.swr <- s/sqrt(n)
```

1. Imagine a warehouse full of `r N` boxes. Each box contains one or more widgets. You select a simple random sample without replacement of `r n` of these boxes and count the number of widgets in each selected box. In that sample the mean number of widgets per box is `r m` widgets and the standard deviation is `r s` widgets. Verify that the confidence interval for the *mean* number of widgets per box for all `r N` boxes in the warehouse is approximately `r m` $\pm$ `r round(2 * se.srs, 2)` widgets per box, and that the confidence interval for the *total* number of widgets in the warehouse is approximately `r format(N*m, scientific = FALSE)` $\pm$ `r round(N*2*se.srs, 2)` widgets. 

```{r}
N <- 160
n <- 16
m <- 4
s <- 2
se <- N*(s/sqrt(n))*sqrt(1 - n/N)
tau <- N*m
```

2. Anthropologists are trying to estimate the population of a village. They know that the village contains `r N` households. The researchers use simple random sampling without replacement to select `r n` households and visit each of the selected households. During their visit they determine how many people live in the household. The researchers compute the mean number of people in those `r n` households to be `r m` people per house, and compute the standard deviation to be `r s` people per house. Verify that their estimate of the mean number of people per house in the village is `r tau/N` people with a margin of error is about `r round(2*se/N, 2)` people, so that the confidence interval for the mean number of people per house is approximately `r tau/N` $\pm$ `r round(2*se/N, 2)`. Also verify that their estimate of the total number of people in the village is `r tau` people, with a margin of error of about `r round(2*se, 2)` people, so that the confidence interval for the total number of people in the village is approxiately `r tau` $\pm$ `r round(2*se, 2)`. 

```{r fruitfly, echo = FALSE}
N <- 25
n <- 10
m <- 500/25
s <- 5
tau <- N*m
se <- N*(s/sqrt(n))*sqrt(1 - n/N)
```

3. A biologist wants to know the number of eggs that are laid by a female fruit fly. She does not want to count all the eggs, as they are quite small and numerous, so she decides to using sampling to estimate the number of eggs. She gently spreads the eggs on a microscope slide that has had a grid drawn on it such that the slide is divided into `r N` squares. The biologist randomly selects `r n` different squares, and using a microscope carefully counts the number of eggs on each of the selected squares. The mean number of eggs on those squares is `r m` eggs, and the standard deviation is `r s` eggs. Confirm that the estimate for the *total* number of eggs on the entire slide is `r tau` eggs, with a margin of error of about `r round(2*se,2)` eggs. 

```{r}
f <- function(N, M, d, n = 0, plot = TRUE) {
  x <- seq(0, 100, by = 100/N)
  fa <- function(x, d) {
    d + x * (50 - d)/100
  }
  fb <- function(x, d) {
    -fa(x, d)
  } 
  par(mai = c(0,0,0,0))
  if (plot) plot(x, fa(x,d), type = "l", ylim = c(-50,50),
    bty = "n", xaxt = "n", yaxt = "n",
    xlab = "", ylab = "")
  if (plot) lines(x, fb(x,d), type = "l")
  for (i in 1:length(x)) {
    if (plot) lines(c(x[i], x[i]), c(fa(x[i], d), fb(x[i], d)))
  }
  t <- 0
  y <- rep(NA, M)
  
  if (n > 0) {
    samp <- sample(1:N, n)
    for (i in 1:length(x)) {
      if (i %in% samp) {
        if (plot) polygon(c(x[i], x[i+1], x[i+1], x[i]), 
                c(fa(x[i], d), fa(x[i+1], d), fb(x[i+1], d), fb(x[i], d)), 
                col = grey(0.85))
      }
    }
  }
  
  while (t < M) {
    p.x <- runif(1, 0, 100)
    p.y <- runif(1, -50, 50)
    if ((p.y < fa(p.x, d)) * (p.y > fb(p.x, d))) {
      t <- t + 1
      if (plot) points(p.x, p.y, pch = 16, cex = 0.25)
      y[t] <- p.x
    }
  }
  if (plot) lines(x, fb(x,d), type = "l")
  for (i in 1:length(x)) {
    if (plot) lines(c(x[i], x[i]), c(fa(x[i], d), fb(x[i], d)))
  }
  y <- cut(y, breaks = seq(0, 100, by = 100/N), labels = FALSE)
  y <- factor(y, labels = 1:N)
  y <- data.frame(transect = 1:N, count = as.vector(table(y)))    
  # if (n > 0) {
  # 	if (plot) axis(1, at = x[-length(x)] + 100/(2*N), labels = FALSE)
  # 	if (plot) axis(1, at = (x[-length(x)] + 100/(2*N))[samp], 
  # 		labels = y$count[y$transect %in% samp], cex.axis = 0.6)
  # }  
  list(pop = y, samp = subset(y, transect %in% samp))
}
set.seed(106)

N.tree <- 20
n.tree <- 5
m.tree <- 5000
tmp <- f(N.tree, m.tree, 50, n.tree, plot = FALSE)$samp

xbar <- mean(tmp$count)
s <- round(sd(tmp$count),2)
se <- N.tree*(s/sqrt(n.tree))*sqrt(1 - n.tree/N.tree)
tau <- N.tree*xbar
```

4. Forestry researchers wish to estimate the number of trees in a rectangular-shaped area of forest (see the figure below). The forest has been divided into several rectangular transects. The researchers select some of these transects using simple random sampling without replacement and counts the number of trees in each of the selected transects. Each point in the figure represents a tree, but only those that were in the selected transects were actually counted. The mean number of trees in the sample of transects is `r xbar` trees, with a standard deviation of `r s` trees. Verify that the estimated total number of trees in the forest is `r format(tau, scientific = FALSE)` trees with a margin of error of about `r format(round(2*se), scientfic = FALSE)` trees. (Note: The population size and sample size are not explicitly stated, but they can be determined from the figure by counting.)

```{r}
g <- function(M, N, n, a1 = 1, b1 = 1, a2 = 1, b2 = 1, ps = 101, ss = 102, plot = TRUE) {
  set.seed(ps)
  x <- rbeta(M, a1, b1) * sqrt(N)
  y <- rbeta(M, a2, b2) * sqrt(N)
  par(mai = c(0,0,0.5,0))
  if (plot) {
    plot(x, y, bty = "n", xlim = c(0, sqrt(N)), xaxt = "n", yaxt = "n",
      ylim = c(0, sqrt(N)), xlab = "", ylab = "", pch = 16, cex = 0.25)
    for (i in 1:(sqrt(N) + 1)) {
      lines(c(i-1,i-1), c(0, sqrt(N)), lty = 3)
      lines(c(0, sqrt(N)), c(i-1,i-1), lty = 3)
    }
  }
  
  x <- cut(x, breaks = 0:sqrt(N), labels = FALSE)
  y <- cut(y, breaks = 0:sqrt(N), labels = FALSE)
  
  d <- expand.grid(x = 1:sqrt(N), y = 1:sqrt(N), f = NA)
  set.seed(ss)
  d$z <- sample(rep(c(0, 1), c(N-n, n)))
  for (i in 1:sqrt(N)) {
    for (j in 1:sqrt(N)) {
      d$f[d$x == i & d$y == j] <- sum(x == i & y == j)
    }
  }
  if (plot) {
    for (i in 1:sqrt(N)) {
      for (j in 1:sqrt(N)) {
        if (d$z[d$x == i & d$y == j]) {
          polygon(c(i - 1, i, i, i - 1), c(j - 1, j - 1, j, j), lwd = 2)
          text(i - 0.5, j - 0.5, d$f[d$x == i & d$y == j])
        }
      }
    }
  }
  d
}
```

```{r}
M.site <- 1000
N.site <- 100
n.site <- 10
out <- g(M.site, N.site, n.site, plot = FALSE, ps = 123, ss = 123)
s <- round(sd(out$f[out$z == 1]), 2)
m <- mean(out$f[out$z == 1])
B <- N.site * 2 * s/sqrt(n.site) * sqrt(1 - n.site/N.site)
```

5. Archaeologists conducted a survey to estimate the number of artifacts at an archaeological site. See the figure below. The site was divided into smaller square regions using a grid system. Each point in the figure represents an artifact, although these cannot be seen by the archaeologists until the grid square is excavated. The number within each grid square represents the number of artifacts within it. A sample of grid squares was selected using simple random sampling without replacement. A sampled grid square is represented by a solid outline. The archaeologists excavated the selected squares and counted the number of artifacts found therein. The mean number of artifacts per grid square sampled was `r m` artifacts, and the standard deviation was `r s` artifacts. Verify that the confidence interval of the total number of artifacts at the site is approximately `r N.site*m` $\pm$ `r round(B)` artifacts. (Note: The population size and sample size are not explicitly stated, but they can be determined from the figure by counting.)

```{r, fig.height = 3, fig.cap = "Illustration of transects in a forest. The transects are the tall rectangles. The grey transects represent those transects that were selected using simple random sampling without replacement."}
set.seed(106)
tmp <- f(N.tree, m.tree, 50, n.tree, plot = TRUE)
```

```{r, fig.height = 7, fig.cap = "Illustration of an archaeological site with grid. The grid squares with solid outlines were those that were selected using simple random sampling without replacement. The number within each selected rectangular area is the number of artifacts found after excavation of the sampled grid square."}
out <- g(M.site, N.site, n.site, ps = 123, ss = 123)
```

```{r}
rm(list = ls())
```

