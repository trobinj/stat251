---
output:
  html_document:
    theme: readable
---

```{r, echo = FALSE, message = FALSE}
library(lubridate)
date <- "11-19-2021"
weekday <- wday(mdy(date), label = TRUE, abbr = FALSE)
month <- month(mdy(date), label = TRUE)
day <- day(mdy(date))
```

---
title: `r paste(weekday, ", ", month, " ", day, sep = "")`
header-includes:
  - \usepackage{array}
  - \usepackage{booktabs}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.align = "center", out.width = "100%", fig.width = 9, cache = FALSE, dev = ifelse(knitr::is_html_output(), "png", "pdf"))
```

```{r packages}
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
```

```{r utilities}
source("../../utilities.R")
```

`r ifelse(knitr::is_html_output(), paste("You can also download a [PDF](lecture-", date, ".pdf) copy of this lecture.", sep = ""), "")`

## Mark-Recapture Designs

The simplest mark-recapture design involves two steps.

1. Select a sample of $n_1$ units. All of these units are *marked* and *replaced* into the population.
2. Select a sample of $n_2$ units and count the number of marked units ($m$) in the sample. 

```{r}
library(shape)

par(mai = c(0,0,0,0) + 0.1)

emptyplot(xlim = c(0, 1), ylim = c(0.2, 0.8))
polygon(x = c(0,0,1,1,0), y = c(0.2,0.8,0.8,0.2,0.2))
plotcircle(mid = c(0.35, 0.5), r = 0.2)
plotcircle(mid = c(0.65, 0.5), r = 0.2)

text(0.5, 0.5, tex("$m$"))
text(0.35, 0.5, tex("$n_1 - m$"))
text(0.65, 0.5, tex("$n_2 - m$"))
text(0.1, 0.25, tex("$N - n_1 - n_2 + m$"))
```

Every unit in the population could be classified in terms of whether it was included or excluded from each sample.
```{r}
d <- data.frame(first = c("included","excluded","Total"),
  included = c("$m$","$n_2-m$","$n_2$"),
  excluded = c("$n_1-m$","$N-n_1-n_2+m$","$N-n_2$"),
  Total = c("$n_1$","$N-n_1$","$N$"))
names(d)[1] <- c("First Sample")
ktbl(d, align = "lccc") %>% add_header_above(c(" " = 1, "Second Sample" = 2, " " = 1)) %>% column_spec(1, bold = knitr::is_html_output())
```

**Example**: A sample of $n_1$ = 300 deer are captured, tagged, and released. A second sample of $n_2$ = 200 deer includes $m$ = 62 tagged deer.
```{r}
d <- data.frame(first = c("included","excluded","Total"),
  included = c(62,138,200),
  excluded = c(238,"?","?"),
  Total = c(300,"?","$N$"))
names(d)[1] <- c("First Sample")
ktbl(d, align = "lccc") %>% add_header_above(c(" " = 1, "Second Sample" = 2, " " = 1)) %>% column_spec(1, bold = knitr::is_html_output())
```

If we *assume* that inclusion/exclusion in the two samples are *independent*, then the *expected count* for a unit being included in *both* samples is
$$
  \frac{R \times C}{T} = \frac{n_1n_2}{N}.
$$
If the sample sizes are not too small, the expected and observed counts for the number of units in both samples will tend to be approximately equal (assuming independence), so we can write
$$
  m \approx \frac{n_1n_2}{N} \Rightarrow N \approx \frac{n_1n_2}{m},
$$
which gives the "Lincoln-Petersen" estimator of $N$,
$$
  \hat{N} = \frac{n_1n_2}{m}.
$$
Another way to motivate this estimator is to observe that the proportion of marked units in the second sample ($m/n_2$) estimates the proportion of marked units in the population ($n_1/N$). So if we write
$$
  \frac{m}{n_2} \approx \frac{n_1}{N},
$$
and "solve" for $N$ we get
$$
  N \approx \frac{n_1 n_2}{m}
$$
which implies the Lincoln-Peterson estimator $\hat{N} = n_1 n_2 / m$. 
\pagebreak

**Example**: Assuming independence of inclusion/exclusion in the two samples, what is our estimate of the number of deer in the mark-recapture study described earlier?

\vspace{3cm}

**Example**: Merry and Pippin want to estimate the number of Hobbits that attended Bilbo's 111-th birthday party. They each made a list of the Hobbits that they talked with at the party. There were 72 Hobbits on Merry's list, 100 Hobbits on Pippin's list, and 50 on both lists. 
```{r}
d <- data.frame(first = c("included","excluded","Total"),
  included = c(50,22,72),
  excluded = c(50,"?","?"),
  Total = c(100,"?","$N$"))
names(d)[1] <- c("Pippin's List")
ktbl(d, align = "lccc") %>% add_header_above(c(" " = 1, "Merry's List" = 2, " " = 1)) %>% column_spec(1, bold = knitr::is_html_output())
```
What is the estimate of the number of Hobbits that attended the party?

> "The invitations were limited to twelve dozen (a number also called by the hobbits one Gross, 
> though the word was not considered proper to use of people); and the guests were selected from 
> all the families to which Bilbo and Frodo were related, with the addition of a few special 
> unrelated friends (such as Gandalf)." --- J. R. R. Tolkien, *The Fellowship of the Ring* 

\pagebreak

## Violations of Independence

In practice, the independence may be violated at least a couple of ways.

1. Capture/marking increases or decreases the probability of recapture.
0. Units vary with respect to their probability of (re)capture.

## Sampling Design and Standard Errors

A confidence interval for $N$ can be written in general as
$$
	\hat{N} \pm \underbrace{z \times 
	\text{standard error of $\hat{N}$}}_{\text{margin of error}}.
$$
But the standard error *depends on the sampling design used*.

**Direct Sampling**: The second sample is selected to obtain $n_2$ units. The size of the second sample ($n_2$) is *fixed* while the number of marked units in that sample ($m$) is *random*. 

**Example**: A sample of 300 deer are captured, tagged, and released. A second random sample of 200 deer is selected using direct sampling. It includes 62 tagged deer. The standard error is

$$
\sqrt{\frac{n_1n_2(n_1-m)(n_2-m)}{m^3}} = \sqrt{\frac{300 \times 200(300-62)(200-62)}{62^3}} \approx 91.
$$
So the confidence interval for $N$ would be approximately
$$
   968 \pm 1.96 \times 91 \Rightarrow 968 \pm 178 \Leftrightarrow (790, 1146).
$$

**Inverse Sampling**: Units sampled until $m$ marked units are observed. The size of the second sample ($n_2$) is *random* while the number of marked units in that sample ($m$) is *fixed*.

**Example**: A sample of 300 deer are captured, tagged, and released. Then deer are observed until 62 tagged dear are observed using inverse sampling. This requires observing 200 deer. The standard error is

$$
\sqrt{\frac{n_1^2n_2(n_2-m)}{m^2(m+1)}} = \sqrt{\frac{300^2 \times 200(200-62)}{62^2(62+1)}} \approx 101.
$$
So the confidence interval for $N$ would be 
$$
   968 \pm 1.96 \times 101 \Rightarrow 968 \pm 199 \Leftrightarrow (769, 1167).
$$
